<html>
  <head>
    <title> CY2ME </title>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://dev.jbear.co/cy2me/assets/cy2me_logo.ico">

    <style>
      body {font-family: 'Noto Sans KR', sans-serif;}
      .lds-ellipsis { display: none; position: relative;width: 80px;height: 30px;}
    .lds-ellipsis div {position: absolute; top: 10px; width: 13px; height: 13px; border-radius: 50%; background: #ddd; animation-timing-function: cubic-bezier(0, 1, 1, 0);}
    .lds-ellipsis div:nth-child(1) {left: 8px; animation: lds-ellipsis1 0.6s infinite;}
    .lds-ellipsis div:nth-child(2) { left: 8px; animation: lds-ellipsis2 0.6s infinite;}
    .lds-ellipsis div:nth-child(3) { left: 32px; animation: lds-ellipsis2 0.6s infinite;}
    .lds-ellipsis div:nth-child(4) {left: 56px;animation: lds-ellipsis3 0.6s infinite; }
    @keyframes lds-ellipsis1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    @keyframes lds-ellipsis3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
    @keyframes lds-ellipsis2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }

    #header { text-align:center; height:45px; line-height:45px; font-weight:bold; font-size:25px; }
    #site { text-align:center; line-height:30px; padding:10px;}
    #description { text-align:center; border-top:1px solid #efefef; border-bottom:1px solid #efefef; line-height:30px; font-size:13px; }
    #droparea { width:90%;  background-color:#eee; text-align:center; margin-top:10px; padding:25px; color:#555; font-size:13px; }
    #filebox {display:inline-flex; padding:10px; padding-bottom:0px;}
    #filebox label { display: inline-block; padding: .5em .75em; color: #555; font-size: 12px; line-height: normal; vertical-align: middle; background-color: #fdfdfd; cursor: pointer; border: 1px solid #ebebeb; border-bottom-color: #e2e2e2; border-radius: .25em; }
    #filebox input[type="file"] { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip:rect(0,0,0,0); border: 0; }
    #filebox .upload-name { padding: .5em .75em; width:200px; font-size: 12px; font-family: inherit; line-height: normal; vertical-align: middle; background-color: #f5f5f5; border: 1px solid #ebebeb; border-bottom-color: #e2e2e2; border-radius: .25em; -webkit-appearance: none; -moz-appearance: none; appearance: none;}

    #analyzer { padding-top:35px;}
    #analyzer .year_count { font-size:30px; color:#999 }
    #analyzer .year_count .val { font-weight:bold; color:#ddd; display:inline-flex; width:1px;}

    #menu { padding:5px; }
    #menu .order-btn { cursor:pointer; display: inline-block; padding: .5em .75em; color: #efefef; font-size: 12px; line-height: normal; vertical-align: middle; background-color: #7285A5; cursor: pointer; border: 1px solid #ebebeb; border-bottom-color: #e2e2e2; border-radius: .25em;}
    #menu .normal-btn { cursor:pointer; display: inline-block; padding: .5em .75em; color: #555; font-size: 12px; line-height: normal; vertical-align: middle; background-color: #fdfdfd; cursor: pointer; border: 1px solid #ebebeb; border-bottom-color: #e2e2e2; border-radius: .25em; }

    #viewer { width:800px; text-align:left; }
    .M { }
    .M .title { display:none; }
    .M .date { font-size:20px; color:#aaa; }
    .B { }
    .B .title { }
    .post { padding:3%;  }
    .post .title { font-size:20px; font-weight:bold; padding-bottom:5px; padding-right:5px; padding-left:5px;  border-bottom:5px solid #777; clear:both;}
    .post .date {padding:5px;}
    .post .time {padding:5px;}
    .post .content{padding:5px; border-top:1px solid #ddd; border-bottom:1px solid #ddd;  background-color:#efefef;}
    .post .content img { display:block; }
    .post .comment { clear:both; }
    .post .comment .name { float:left; font-weight:bold; padding:5px;}
    .post .comment .value { float:left; padding:5px; max-width:90%; text-align:left;}
    </style>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154897877-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-154897877-1');
    </script>
    <script src='https://dev.jbear.co/cy2me/assets/jquery-3.4.1.min.js'></script>
    <script>
      var contents = null;
      var analyzedData = {};
      
      function analyzeContent(_item) {
          var year = _item.date.split(".")[0];
          if(analyzedData[year] !== undefined) {
              analyzedData[year].count++;
          } else {
              analyzedData[year] = {
                  'count' : 1
              };
          }
          analyzedData[year]
      }

      function wrapLoadingBar(callback) {
        $(".lds-ellipsis").css("display", "inline-block");          
        setTimeout(function() {
            callback();
            $(".lds-ellipsis").css("display", "none");              
        }, 100);
      }

      function reloadContent(_order) {
        wrapLoadingBar(function() {
            $("#viewer").html("");
            $("#analyzer").html("");
            analyzedData = {};
            showContent(contents, _order);
        });
      }

      function saveAs(filename, file) {
        var a = document.createElement("a"),
        url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);  
        }, 0); 
      }

      function printImageList() {
        var ret = "";
        var imageCount = 0;

        var allImages = $("img");
        for(var i = 0; i < allImages.length; i++) {
            imageCount++;
            var img_path = allImages[i].src;
            var img_extension = img_path.split(".").pop();
            var dt = $(".date", allImages[i].parentNode.parentNode)[0].innerText.split(" ")[0];
            var tm = $(".date", allImages[i].parentNode.parentNode)[0].innerText.split(" ")[1];
            ret += img_path + " " + dt.replace(/\./gi, "") + "_" + tm.replace(/\:/gi, "") + "00." + imageCount + "." + img_extension + " " + dt.replace(/\./gi, ":") + " " + tm + "\n";
        }
        /*
        var allPosts = contents;
        for(var i = 0 ; i < allPosts.length; i++) {
            if(allPosts[i].type != "2")
                continue;
            imageCount++;
            ret += "http://nthumb.cyworld.com/thumb?v=0&width=810&url=" + allPosts[i].image + " " + allPosts[i].date.replace(/\./gi, "") + "_" + allPosts[i].time.replace(/\:/gi, "") + "00." + imageCount + "." + allPosts[i].image.split(".").pop() + " " + allPosts[i].date.replace(/\./gi, ":") + " " + allPosts[i].time + "\n";
        }*/
        return ret;
      }

      function downloadPhotos() {
        if(contents) {
            var file = new Blob([printImageList()], {type: "text/plain;charset=utf-8"});
            saveAs("MyCyPhotos_download_script_" + Date().replace(/\ /gi, "_").split("_GMT")[0] + ".txt", file);
        } else {
            alert("컨텐츠가 비어있습니다.");
        }
      }

      function downloadViewer() {
          (function(){
              var base64_url =  'data:text/attachment;base64,' + window.btoa(unescape(encodeURIComponent(document.documentElement.innerHTML)));
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = base64_url;
              a.download = 'cy2me.html';
              document.body.appendChild(a);
              a.click();
          })();
      }

      function addFavorite() {
          pageTitle=document.title;
	  pageURL=document.location;

          try {
	      // Mozilla Firefox solution
	      window.sidebar.addPanel(pageTitle, pageURL, "");
	  }
	  catch (e) {
	      // Opera solution
	      if (typeof(opera)=="object") {
		  a.rel="sidebar";
		  a.title=pageTitle;
		  a.url=pageURL;
		  return true;
	      } else {
		  // The rest browsers (i.e Chrome, Safari)
		  alert('Press ' + (navigator.userAgent.toLowerCase().indexOf('mac') != -1 ? 'Cmd' : 'Ctrl') + '+D 를 누르시면 즐겨찾기 추가됩니다.');
	      }
	  }
      }

      function showContent(_json, _order=true) {
          var viewer = $("#viewer");
          
          for(var i = 0; i < _json.length; i++) {
              var idx = i;

              if(typeof _json[idx].isCompleted !== 'undefined') {
                if(_json[idx].isCompleted != true)
                    continue;
              }
              
              if(_order == false) {
                idx = _json.length - (1 + i);
              }
              analyzeContent(_json[idx]);
              var post = $("<div class='post'>");
              switch(_json[idx].type){
              case "M":
              case "O":
                  post = $("<div class='post M'>");
                  break;
              case "B":
              case "1":
              case "2":
                  post = $("<div class='post B'>");
                  break;
              default:
                  break;
              }

              post.append($("<div class='title'>").text($('<textarea/>').html(_json[idx].title).text()));
              post.append($("<div class='date'>").text(_json[idx].date + "\t\t" + _json[idx].time));
              post.append($("<div class='content'>").html(_json[idx].content));
              if(_json[idx].comments !== undefined) {
                  for(var j = 0; j < _json[idx].comments.length; j++) {
                      var comment = $("<div class='comment'>");
                      comment.append($("<div class='name'>").text(_json[idx].comments[j].name));
                      comment.append($("<div class='value'>").text(_json[idx].comments[j].value));
                      post.append(comment);
                  }
              }
              viewer.append(post);
          }

          var analyzedViewer = $("#analyzer");
          for(var a_idx in analyzedData) {
              var year_count = $("<div class='year_count'>");
              year_count.html(a_idx + " <div class='val'>" + analyzedData[a_idx].count + "</div>");
              analyzedViewer.append(year_count);
          }
      }
      $(document).ready(function() {
          var dropZone = $("#droparea");
          dropZone.on('dragenter', function(e) {
              e.stopPropagation();
              e.preventDefault();
              dropZone.css('background-color', "#E3F2FC");
          });

          dropZone.on('dragleave', function(e) {
              e.stopPropagation();
              e.preventDefault();

              dropZone.css('background-color', "#EEEEEE");
          });

          dropZone.on('dragover', function(e) {
              e.stopPropagation();
              e.preventDefault();

              dropZone.css("background-color", "#E3F2FC");
          });


          function loadFile(file) {
              if(file != null) {
                  if(file.length < 1) {
                      alert('folder is not supported');
                      return;
                  }
                  file = file[0];
                  $("#fileinput").siblings('.upload-name').val(file.name);
                  var reader = new FileReader();
                  reader.onload = function(ee) {
                    wrapLoadingBar(function() {
                        contents = ee.target.result;
                        try {
                            contents = JSON.parse(contents);
                            $("#viewer").html("");
                            $("#analyzer").html("");
                            analyzedData = {};
                            showContent(contents);
                        } catch(exception) {
                            alert("JSON이 아닙니다. 지원하지 않는 포맷입니다.");
                        }
                    });  
                  };

                  reader.readAsText(file);
              } else {
                  alert('error');
              }
          }
          
          dropZone.on('drop', function(e) {
              e.preventDefault();
              dropZone.css('background-color', '#EEEEEE');
              loadFile(e.originalEvent.dataTransfer.files);
          });

          $("#fileinput").on('change', function(e) {
              loadFile(this.files);
          });
      });
    </script>
  </head>
  <body>
    <div id='header'>
      CY2ME Viewer
    </div>
    <div id='site'>
      README  / <a href = 'https://github.com/designe/cy2me' target='_blank'> https://github.com/designe/cy2me </a><br/>
      Q&A / <a href = 'https://blog.jbear.co/post/cyworld_backup/' target='_blank'> https://blog.jbear.co/post/cyworld_backup </a>
    </div>
    <div id='description'>
      본 페이지는 cy2me를 통해 백업받은 텍스트 파일을 보다 깔끔하게 확인할 수 있도록 도와주는 뷰어입니다.
    </div>
    <center>
    <div id="droparea">
      이곳에 싸이월드 백업 파일을 끌어놓으세요.<br/>
      <div id="filebox">
        <input class="upload-name" value="파일선택" disabled="disabled">
        <label for="fileinput">파일 찾기</label>
        <input type="file" id="fileinput" />
      </div>
    </div>
    <div id='menu'>
        <span class='order-btn' onclick='reloadContent(false);'>오름차순</span>
        <span class='order-btn' onclick='reloadContent(true);'>내림차순</span>
        <span class='order-btn' onclick='downloadPhotos()');'>모든 사진 다운로드</span>
        <span class='normal-btn' onclick='downloadViewer()');'>Viewer 다운로드</span>
        <span class='normal-btn' onclick='addFavorite();'>즐겨찾기 추가</span><br/>
        <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
    </div>
    <div id='analyzer'>
    </div>
    <div id="viewer">
    </div>
    </center>
  </body>
</html>
